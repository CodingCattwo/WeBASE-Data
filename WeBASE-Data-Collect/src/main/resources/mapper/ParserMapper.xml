<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--对应mapper接口 -->
<mapper namespace="com.webank.webase.data.collect.parser.ParserMapper">
	<resultMap id="parserMap"
		type="com.webank.webase.data.collect.parser.entity.TbParser">
		<result column="user_name" javaType="java.lang.String"
			jdbcType="VARCHAR" property="userName" />
		<result column="user_type" javaType="java.lang.Integer"
			jdbcType="INTEGER" property="userType" />
		<result column="contract_name" javaType="java.lang.String"
			jdbcType="VARCHAR" property="contractName" />
		<result column="contract_address" javaType="java.lang.String"
			jdbcType="VARCHAR" property="contractAddress" />
		<result column="interface_name" javaType="java.lang.String"
			jdbcType="VARCHAR" property="interfaceName" />
		<result column="trans_type" javaType="java.lang.Integer"
			jdbcType="INTEGER" property="transType" />
		<result column="trans_unusual_type" javaType="java.lang.Integer"
			jdbcType="INTEGER" property="transUnusualType" />
		<result column="trans_count" javaType="java.lang.Integer"
			jdbcType="INTEGER" property="transCount" />
		<result column="trans_hashs" javaType="java.lang.String"
			jdbcType="VARCHAR" property="transHashs" />
		<result column="trans_hash_lastest" javaType="java.lang.String"
			jdbcType="VARCHAR" property="transHashLastest" />
		<result column="create_time" javaType="java.time.LocalDateTime"
			jdbcType="TIMESTAMP" property="createTime" />
		<result column="modify_time" javaType="java.time.LocalDateTime"
			jdbcType="TIMESTAMP" property="modifyTime" />
	</resultMap>

	<insert id="add">
		insert into ${tableName}
		(user_name,user_type,contract_name,contract_address,interface_name,trans_type,
		trans_unusual_type,trans_count,trans_hashs,trans_hash_lastest,create_time,modify_time)
		values
		(#{parser.userName},#{parser.userType},#{parser.contractName},
		#{parser.contractAddress},#{parser.interfaceName},#{parser.transType},
		#{parser.transUnusualType},#{parser.transCount},#{parser.transHashs},
		#{parser.transHashLastest},now(),now())
	</insert>

	<update id="update">
		update ${tableName}
		set trans_count = trans_count + 1,
		trans_hashs = #{parser.transHashs},
		trans_hash_lastest =
		#{parser.transHashLastest},
		modify_time = now()
		where user_name =
		#{parser.userName}
		and contract_name = #{parser.contractName}
		and
		DATE_FORMAT(create_time,'%Y-%m-%d %H:%i:%s') =
		DATE_FORMAT(#{parser.createTime},'%Y-%m-%d %H:%i:%s')
		and user_type =
		#{parser.userType}
		and contract_address = #{parser.contractAddress}
		and
		interface_name = #{parser.interfaceName}
		and trans_type =
		#{parser.transType}
		and trans_unusual_type = #{parser.transUnusualType}
	</update>

	<update id="updateUnusualUser">
		update ${tableName}
		set user_name = #{userName},
		user_type = 0
		where user_name = #{address}
		and user_type = 1
	</update>

	<update id="updateUnusualContract">
		update ${tableName}
		set contract_name =
		#{contractName},
		interface_name = #{interfaceName},
		trans_unusual_type =
		#{transUnusualType}
		where contract_name = #{contractBin}
		and
		(trans_unusual_type = 1 or trans_unusual_type = 2)
	</update>

	<select id="queryTbParser"
		resultType="com.webank.webase.data.collect.parser.entity.TbParser">
		select trans_count as transCount,trans_hashs as transHashs
		from ${tableName}
		where user_name = #{parser.userName}
		and contract_name
		= #{parser.contractName}
		and DATE_FORMAT(create_time,'%Y-%m-%d
		%H:%i:%s') =
		DATE_FORMAT(#{parser.createTime},'%Y-%m-%d %H:%i:%s')
		and
		user_type = #{parser.userType}
		and contract_address =
		#{parser.contractAddress}
		and interface_name = #{parser.interfaceName}
		and trans_type = #{parser.transType}
		and trans_unusual_type =
		#{parser.transUnusualType}
		limit 1
	</select>

	<select id="parserUserList"
		resultType="com.webank.webase.data.collect.parser.entity.TbParser">
		select distinct user_name as userName from ${tableName}
	</select>

	<select id="parserInterfaceList"
		resultType="com.webank.webase.data.collect.parser.entity.TbParser">
		select distinct interface_name as interfaceName from ${tableName}
		where 1=1
		<if test="userName != null and userName != ''">
			and user_name = #{userName}
		</if>
	</select>

	<select id="countOfParserTrans" parameterType="Map"
		resultType="java.lang.Integer">
		select IFNULL(sum(trans_count),0) from ${tableName} where 1=1
		<if test="userName != null and userName != ''">
			and user_name = #{userName}
		</if>
		<if test="startDate != null and startDate != ''">
      <![CDATA[ and DATE_FORMAT(modify_time,'%Y-%m-%d') >= STR_TO_DATE(#{startDate},'%Y-%m-%d') ]]>
		</if>
		<if test="endDate != null and endDate != ''">
      <![CDATA[ and DATE_FORMAT(modify_time,'%Y-%m-%d') <= STR_TO_DATE(#{endDate},'%Y-%m-%d') ]]>
		</if>
		<if test="interfaceName != null and interfaceName != ''">
			and interface_name = #{interfaceName}
		</if>
	</select>

	<select id="qureyTransCountList" parameterType="Map"
		resultType="com.webank.webase.data.collect.parser.entity.PageTransInfo">
		select
		trans_count as transCount,
		modify_time as time
		from ${tableName}
		where 1=1
		<if test="userName != null and userName != ''">
			and user_name = #{userName}
		</if>
		<if test="startDate != null and startDate != ''">
      <![CDATA[ and DATE_FORMAT(modify_time,'%Y-%m-%d') >= STR_TO_DATE(#{startDate},'%Y-%m-%d') ]]>
		</if>
		<if test="endDate != null and endDate != ''">
      <![CDATA[ and DATE_FORMAT(modify_time,'%Y-%m-%d') <= STR_TO_DATE(#{endDate},'%Y-%m-%d') ]]>
		</if>
		<if test="interfaceName != null and interfaceName != ''">
			and interface_name = #{interfaceName}
		</if>
		order by modify_time
	</select>

	<select id="countOfUnusualUser" resultType="java.lang.Integer">
		select count(distinct user_name)
		from ${tableName}
		where user_type=1
		<if test="userName != null and userName != ''">
			and user_name like CONCAT('%',#{userName},'%')
		</if>
	</select>

	<select id="listOfUnusualUser" parameterType="Map"
		resultType="com.webank.webase.data.collect.parser.entity.UnusualUserInfo">
		select user_name as userName,sum(trans_count) as transCount,
		max(trans_hashs) as hashs, max(modify_time) as time
		from ${tableName}
		where user_type=1
		<if test="userName != null and userName != ''">
			and user_name like CONCAT('%',#{userName},'%')
		</if>
		group by user_name
		<if test="start != null and pageSize != null">
			limit #{start},#{pageSize}
		</if>
	</select>

	<select id="countOfUnusualContract" resultType="java.lang.Integer">
		select count(distinct contract_address)
		from ${tableName}
		where
		trans_unusual_type=1
		<if test="contractAddress != null and contractAddress != ''">
			and contract_address like
			CONCAT('%',#{contractAddress},'%')
		</if>
	</select>

	<select id="listOfUnusualContract" parameterType="Map"
		resultType="com.webank.webase.data.collect.parser.entity.UnusualContractInfo">
		select contract_address as contractAddress,max(contract_name) as
		contractName,sum(trans_count) as transCount,
		max(trans_hashs) as
		hashs,max(modify_time) as time
		from ${tableName} where
		trans_unusual_type=1
		<if test="contractAddress != null and contractAddress != ''">
			and contract_address like
			CONCAT('%',#{contractAddress},'%')
		</if>
		group by contract_address
		<if test="start != null and pageSize != null">
			limit #{start},#{pageSize}
		</if>
	</select>

	<select id="queryUnusualTxhash" resultType="java.lang.String">
		select trans_hash
		from ${tableName}
		where contract_name = #{contractBin}
		and (trans_unusual_type = 1 or trans_unusual_type = 2)
	</select>
</mapper>