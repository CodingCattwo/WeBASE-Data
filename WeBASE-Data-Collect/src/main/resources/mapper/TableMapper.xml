<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.webank.webase.data.collect.table.TableMapper">

	<update id="createTbChain">
		CREATE TABLE IF NOT EXISTS tb_chain (
		id int(11) NOT NULL AUTO_INCREMENT COMMENT '编号',
		chain_id int(11) NOT NULL COMMENT '区块链编号',
		chain_name varchar(120) DEFAULT NULL COMMENT '区块链名称',
		chain_type tinyint(4) DEFAULT '0' COMMENT '类型（ 0-非国密 1-国密）',
		description varchar(1024) COMMENT '描述',
		create_time datetime DEFAULT NULL COMMENT '创建时间',
		modify_time datetime DEFAULT NULL COMMENT '修改时间',
		PRIMARY KEY (id),
		UNIQUE KEY uk_chain (chain_id),
		UNIQUE KEY uk_name (chain_name)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='区块链信息表';
	</update>

	<update id="createTbFront">
		CREATE TABLE IF NOT EXISTS tb_front (
		front_id int(11) NOT NULL AUTO_INCREMENT COMMENT '前置服务编号',
		chain_id int(11) NOT NULL COMMENT '所属区块链编号',
		node_id varchar(250) NOT NULL COMMENT '节点编号',
		front_ip varchar(16) NOT NULL COMMENT '前置服务ip',
		front_port int(11) DEFAULT NULL COMMENT '前置服务端口',
		agency varchar(32) NOT NULL COMMENT '所属机构名称',
		create_time datetime DEFAULT NULL COMMENT '创建时间',
		modify_time datetime DEFAULT NULL COMMENT '修改时间',
		PRIMARY KEY (front_id),
		UNIQUE KEY uk_chain_node (chain_id,node_id)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='前置服务信息表';
	</update>

	<update id="createTbGroup">
		CREATE TABLE IF NOT EXISTS tb_group (
		id int(11) NOT NULL AUTO_INCREMENT COMMENT '编号',
		group_id int(11) NOT NULL COMMENT '群组ID',
		chain_id int(11) NOT NULL COMMENT '所属区块链编号',
		genesis_block_hash varchar(128) NOT NULL COMMENT '创世块hash',
		group_name varchar(64) NOT NULL COMMENT '群组名字',
		group_status tinyint(4) DEFAULT '1' COMMENT '状态（1-正常 2-异常）',
		node_count int DEFAULT '0' COMMENT '群组下节点数',
		group_desc varchar(1024) COMMENT '群组描述',
		create_time datetime DEFAULT NULL COMMENT '创建时间',
		modify_time datetime DEFAULT NULL COMMENT '修改时间',
		PRIMARY KEY (id),
		UNIQUE KEY uk_group_chain (group_id,chain_id)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='群组信息表';
	</update>

	<update id="createTbFrontGroupMap">
		CREATE TABLE IF NOT EXISTS tb_front_group_map (
		map_id int(11) NOT NULL AUTO_INCREMENT COMMENT '编号',
		chain_id int(11) NOT NULL COMMENT '区块链编号',
		front_id int(11) NOT NULL COMMENT '前置服务编号',
		group_id int(11) NOT NULL COMMENT '群组编号',
		create_time datetime DEFAULT NULL COMMENT '创建时间',
		modify_time datetime DEFAULT NULL COMMENT '修改时间',
		PRIMARY KEY (map_id),
		UNIQUE KEY uk_chain_front_group (chain_id,front_id,group_id)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='前置群组映射表';
	</update>
	
	<update id="createTbUser">
		CREATE TABLE IF NOT EXISTS tb_user (
	    user_id int(11) NOT NULL AUTO_INCREMENT COMMENT '用户编号',
	    user_name varchar(64) binary NOT NULL COMMENT '用户名',
	    address varchar(64) DEFAULT NULL COMMENT '链上地址',
	    description varchar(250) DEFAULT NULL COMMENT '备注',
	    create_time datetime DEFAULT NULL COMMENT '创建时间',
	    modify_time datetime DEFAULT NULL COMMENT '修改时间',
	    PRIMARY KEY (user_id),
	    UNIQUE KEY uk_address (address)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户信息表';
	</update>
	
	<update id="createTbContract">
		CREATE TABLE IF NOT EXISTS tb_contract (
	    contract_id int(11) NOT NULL AUTO_INCREMENT COMMENT '合约编号',
	    chain_id int(11) NOT NULL COMMENT '所属区块链编号',
	    group_id int(11) NOT NULL COMMENT '所属群组编号',
	    contract_path varchar(24) binary NOT NULL COMMENT '合约所在目录',
	    contract_name varchar(120) binary NOT NULL COMMENT '合约名称',
	    contract_source text COMMENT '合约源码',
	    contract_abi text COMMENT '编译合约生成的abi文件内容',
	    contract_bin text COMMENT '合约运行时binary，用于合约解析',
	    bytecode_bin text COMMENT '合约bytecode binary，用于部署合约',
	    contract_type tinyint(4) DEFAULT '0' COMMENT '合约类型(0-普通合约，1-系统合约)',
	    description varchar(1024) COMMENT '描述',
	    create_time datetime DEFAULT NULL COMMENT '创建时间',
	    modify_time datetime DEFAULT NULL COMMENT '修改时间',
	    PRIMARY KEY (contract_id),
	    UNIQUE KEY uk_group_path_name (chain_id,group_id,contract_path,contract_name)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='合约表';
	</update>
	
	<update id="createTbMethod">
		CREATE TABLE IF NOT EXISTS tb_method (
		id int(11) NOT NULL AUTO_INCREMENT COMMENT '自增编号',
		contract_id int(11) NOT NULL COMMENT '所属合约编号',
		chain_id int(11) NOT NULL COMMENT '所属区块链编号',
	    group_id int(11) NOT NULL COMMENT '所属群组编号',
		method_id varchar(128) COMMENT '方法id',
		method_name varchar(128) COMMENT '方法名',
		abi_info text COMMENT 'abi信息',
		method_type varchar(32) COMMENT '方法类型',
		create_time datetime DEFAULT NULL COMMENT '创建时间',
		modify_time datetime DEFAULT NULL COMMENT '修改时间',
		PRIMARY KEY (id),
		UNIQUE KEY uk_method (chain_id,group_id,method_id)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='方法解析信息表';
	</update>
	
	<update id="createTbTaskPool" parameterType="java.lang.String">
		CREATE TABLE IF NOT EXISTS ${tableName}(
		id bigint NOT NULL AUTO_INCREMENT COMMENT '自增编号',
		block_number bigint(25) NOT NULL COMMENT '块高',
		sync_status tinyint(4) NOT NULL COMMENT '同步状态',
		certainty tinyint(4) NOT NULL COMMENT '确定性',
		handle_item tinyint(4) NOT NULL COMMENT '处理项',
		create_time datetime DEFAULT NULL COMMENT '创建时间',
		modify_time datetime DEFAULT NULL COMMENT '修改时间',
		PRIMARY KEY (id),
		UNIQUE KEY uk_number (block_number),
		KEY index_status (sync_status)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='区块拉取任务信息表';
	</update>

	<update id="createTbBlock" parameterType="java.lang.String">
		CREATE TABLE IF NOT EXISTS ${tableName}(
		id bigint NOT NULL AUTO_INCREMENT COMMENT '自增编号',
		block_number bigint(25) NOT NULL COMMENT '块高',
		block_hash varchar(128) NOT NULL COMMENT '块hash',
		block_timestamp datetime NOT NULL COMMENT '出块时间',
		sealer_index int(4) NOT NULL COMMENT '打包节点索引',
		sealer varchar(250) DEFAULT NULL COMMENT '打包节点',
		trans_count int(11) DEFAULT '0' COMMENT '块包含的交易数',
		status tinyint(4) NOT NULL COMMENT '处理状态',
		create_time datetime DEFAULT NULL COMMENT '创建时间',
		modify_time datetime DEFAULT NULL COMMENT '修改时间',
		PRIMARY KEY (id),
		UNIQUE KEY uk_number (block_number)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='区块信息表';
	</update>

	<update id="createTbTransaction" parameterType="java.lang.String">
		CREATE TABLE IF NOT EXISTS ${tableName} (
		id bigint NOT NULL AUTO_INCREMENT COMMENT '自增编号',
		trans_hash varchar(128) NOT NULL COMMENT '交易hash',
		block_number bigint(25) NOT NULL COMMENT '所属区块',
		trans_from varchar(64) DEFAULT NULL COMMENT 'from',
		trans_to varchar(64) DEFAULT NULL COMMENT 'to',
		input text DEFAULT NULL COMMENT '输入信息',
		block_timestamp datetime NOT NULL COMMENT '所属块出块时间',
		audit_flag tinyint(4) DEFAULT '1' COMMENT '是否已统计（1-未审计，2-已审计）',
		create_time datetime DEFAULT NULL COMMENT '创建时间',
		modify_time datetime DEFAULT NULL COMMENT '修改时间',
		PRIMARY KEY (id),
		UNIQUE KEY uk_hash (trans_hash),
		KEY index_flag (audit_flag),
		KEY index_number (block_number)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='交易信息表';
	</update>

	<update id="createTbReceipt" parameterType="java.lang.String">
		CREATE TABLE IF NOT EXISTS ${tableName} (
		id bigint NOT NULL AUTO_INCREMENT COMMENT '自增编号',
		trans_hash varchar(128) NOT NULL COMMENT '交易hash',
		contract_address varchar(128) NOT NULL COMMENT '合约地址',
		block_number bigint(25) NOT NULL COMMENT '所属区块',
		status varchar(8) COMMENT '交易状态',
		output text COMMENT '输出信息',
		create_time datetime DEFAULT NULL COMMENT '创建时间',
		modify_time datetime DEFAULT NULL COMMENT '修改时间',
		PRIMARY KEY (id),
		UNIQUE KEY uk_hash (trans_hash),
		KEY index_number (block_number)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='交易回执信息表';
	</update>

	<update id="createTbAudit" parameterType="java.lang.String">
		CREATE TABLE IF NOT EXISTS ${tableName} (
		id bigint NOT NULL AUTO_INCREMENT COMMENT '自增编号',
		trans_hash varchar(128) COMMENT '交易hash',
		user_name varchar(128) NOT NULL COMMENT '用户名称',
		user_type tinyint(4) DEFAULT '0' COMMENT '用户类型(0-正常，1-异常)',
		contract_name varchar(128) NOT NULL COMMENT '合约名称',
		contract_address varchar(64) COMMENT '合约地址',
		interface_name varchar(32) COMMENT '合约接口名',
		trans_type tinyint(4) DEFAULT '0' COMMENT '交易类型(0-合约部署，1-接口调用)',
		trans_unusual_type tinyint(4) DEFAULT '0' COMMENT '交易异常类型(0-正常，1-异常合约，2-异常接口)',
		create_time datetime DEFAULT NULL COMMENT '创建时间',
		modify_time datetime DEFAULT NULL COMMENT '修改时间',
		PRIMARY KEY (id),
		INDEX idx_un (user_name),
		INDEX idx_cn (contract_name)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户交易监管统计表';
	</update>

	<select id="queryTables" resultType="java.lang.String">
		select table_name from information_schema.tables where
		table_schema=#{dbName}
		<if test="tableName != null">
			and table_name = #{tableName}
		</if>
	</select>

	<delete id="deleteByTableName" parameterType="java.lang.String">
		delete from
		${tableName} limit 1000
	</delete>

	<update id="dropTable" parameterType="java.lang.String">
		drop table if exists
		${tableName}
	</update>

</mapper>
